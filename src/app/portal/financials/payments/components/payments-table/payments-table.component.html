<div class="table-responsive" *ngIf="data">
  <table
    mat-table
    [dataSource]="data"
    multiTemplateDataRows
    style="width: auto; overflow-x: scroll">
    <ng-container matColumnDef="detail">
      <td
        mat-cell
        *matCellDef="let element"
        [attr.colspan]="displayedColumns.length">
        <div class="p-3 payments-container">
          <div class="payments-header d-flex align-items-center mb-3">
            <mat-icon class="me-2">receipt</mat-icon>
            <span class="fw-bold">Payment Applications</span>
            <span
              class="ms-auto text-muted small"
              *ngIf="element.payments?.length">
              {{ element.payments.length }} record{{
                element.payments.length > 1 ? 's' : ''
              }}
            </span>
          </div>

          <ng-container *ngIf="element.payments?.length; else noApplications">
            <div class="mat-elevation-z2 rounded overflow-hidden">
              <table
                mat-table
                [dataSource]="element.payments"
                class="w-100"
                role="grid">
                <ng-container matColumnDef="policy">
                  <th mat-header-cell *matHeaderCellDef>Policy Number</th>
                  <td mat-cell *matCellDef="let item">
                    #{{ item.policy.policy_number || '—' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="invoice">
                  <th mat-header-cell *matHeaderCellDef>Invoice Serial</th>
                  <td mat-cell *matCellDef="let item">
                    {{ item.invoice.serial }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="applied">
                  <th mat-header-cell *matHeaderCellDef class="text-end">
                    Payment Applied
                  </th>
                  <td mat-cell *matCellDef="let item" class="text-end mono">
                    {{ item.payment_applied | currency }}
                  </td>
                </ng-container>

                <tr
                  mat-header-row
                  *matHeaderRowDef="['policy', 'invoice', 'applied']"></tr>
                <tr
                  mat-row
                  *matRowDef="
                    let row;
                    columns: ['policy', 'invoice', 'applied']
                  "></tr>
              </table>
            </div>
          </ng-container>

          <ng-template #noApplications>
            <div class="d-flex align-items-center text-muted py-2">
              <mat-icon class="me-2">info</mat-icon>
              No payment applications linked.
            </div>
          </ng-template>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="serial">
      <th mat-header-cell *matHeaderCellDef>Payment Number</th>
      <td
        mat-cell
        *matCellDef="let element"
        class="light-blue-700"
        style="cursor: pointer">
        <span
          class="me-2"
          (click)="toggleRow(element); $event.stopPropagation()"
          style="user-select: none">
          {{ expanded === element ? '▾' : '▸' }}
        </span>

        <span (click)="_url.navigateTo('portal/payments', element.serial)">
          #{{ element.serial | notNull }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="ach_number">
      <th mat-header-cell *matHeaderCellDef>Check/ACH Number</th>
      <td mat-cell *matCellDef="let element">{{ element.ach_number }}</td>
    </ng-container>

    <ng-container matColumnDef="payment_from">
      <th mat-header-cell *matHeaderCellDef>Entity</th>
      <td mat-cell *matCellDef="let element">
        {{ element.payment_from }}
      </td>
    </ng-container>

    <ng-container matColumnDef="payment_for">
      <th mat-header-cell *matHeaderCellDef>Payment From</th>
      <td mat-cell *matCellDef="let element">
        {{
          element.payment_from === 'Insurer'
            ? element.payment_from_data.insurer
            : element.payment_from_data.account
        }}
      </td>
    </ng-container>

    <ng-container matColumnDef="payment_date">
      <th mat-header-cell *matHeaderCellDef>Payment Date</th>
      <td mat-cell *matCellDef="let element">
        {{ element.payment_date | date | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="total_amount">
      <th mat-header-cell *matHeaderCellDef>Total Amount</th>
      <td mat-cell *matCellDef="let element">
        {{ element.total_amount | currency | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="subtotal">
      <th mat-header-cell *matHeaderCellDef>Subtotal</th>
      <td mat-cell *matCellDef="let element">
        {{ element.subtotal | currency | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="taxes">
      <th mat-header-cell *matHeaderCellDef>Taxes</th>
      <td mat-cell *matCellDef="let element">
        {{ element.taxes | currency | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="retentions">
      <th mat-header-cell *matHeaderCellDef>Retentions</th>
      <td mat-cell *matCellDef="let element">
        {{ element.retentions | currency | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="balance">
      <th mat-header-cell *matHeaderCellDef>Remaining Balance</th>
      <td mat-cell *matCellDef="let element">
        {{ element.remaining_balance | currency | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td
        mat-cell
        *matCellDef="let element"
        [ngClass]="getStatusClass(element.status)"
        class="fw-semibold">
        {{ element.status | enum | notNull }}
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

    <tr
      mat-row
      *matRowDef="let row; columns: displayedColumns"
      class="mas-table-row"
      (click)="toggleRow(row)"
      style="cursor: pointer"></tr>

    <tr
      mat-row
      *matRowDef="let row; columns: ['detail']"
      [style.display]="expanded === row ? 'table-row' : 'none'"
      class="bg-light"></tr>

    <tr *matNoDataRow>
      <td colspan="9">
        <app-default-empty-state
          [url]="'portal/payments/new'"
          *ngIf="!filtersActive.length"></app-default-empty-state>
        <app-filter-empty-state
          *ngIf="filtersActive.length"></app-filter-empty-state>
      </td>
    </tr>
  </table>
</div>

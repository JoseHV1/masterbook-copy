<div class="table-responsive" *ngIf="data">
  <table
    mat-table
    [dataSource]="data"
    multiTemplateDataRows
    style="width: auto; overflow-x: scroll">
    <ng-container matColumnDef="detail">
      <td
        mat-cell
        *matCellDef="let element"
        [attr.colspan]="displayedColumns.length">
        <div class="p-3 payments-container">
          <div class="payments-header d-flex align-items-center mb-3">
            <mat-icon class="me-2">receipt_long</mat-icon>
            <span class="fw-bold">Payments</span>
            <span
              class="ms-auto text-muted small"
              *ngIf="element.payments?.length">
              {{ element.payments.length }} record{{
                element.payments.length > 1 ? 's' : ''
              }}
            </span>
          </div>

          <ng-container *ngIf="element.payments as pays; else paymentsState">
            <ng-container *ngIf="pays.length; else noPayments">
              <div class="mat-elevation-z2 rounded overflow-hidden">
                <table
                  mat-table
                  [dataSource]="pays"
                  class="w-100 payments-table"
                  role="grid">
                  <ng-container matColumnDef="serial">
                    <th mat-header-cell *matHeaderCellDef>Serial</th>
                    <td mat-cell *matCellDef="let payment">
                      <span class="mono">{{ payment.serial }}</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef>Date</th>
                    <td mat-cell *matCellDef="let payment">
                      {{ payment.payment_date | date : 'mediumDate' }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="amount">
                    <th mat-header-cell *matHeaderCellDef class="text-end">
                      Amount
                    </th>
                    <td
                      mat-cell
                      *matCellDef="let payment"
                      class="text-end mono">
                      {{ payment.payment_applied | currency }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="method">
                    <th mat-header-cell *matHeaderCellDef class="text-center">
                      Method
                    </th>
                    <td mat-cell *matCellDef="let payment">
                      <div
                        class="d-flex align-items-center justify-content-center">
                        <mat-chip-set>
                          <mat-chip
                            appearance="outlined"
                            matTooltip="{{ payment.method | enum }}">
                            <mat-icon
                              *ngIf="
                                (payment.method || '').toLowerCase() === 'ach'
                              "
                              >account_balance</mat-icon
                            >
                            <mat-icon
                              *ngIf="
                                (payment.method || '').toLowerCase() === 'card'
                              "
                              >credit_card</mat-icon
                            >
                            <mat-icon
                              *ngIf="
                                (payment.method || '').toLowerCase() === 'cash'
                              "
                              >payments</mat-icon
                            >
                            <span class="ms-1">{{
                              payment.method | enum
                            }}</span>
                          </mat-chip>
                        </mat-chip-set>
                      </div>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="ach">
                    <th mat-header-cell *matHeaderCellDef>ACH Number</th>
                    <td mat-cell *matCellDef="let payment" class="mono">
                      {{ payment.ach_number || '—' }}
                    </td>
                  </ng-container>

                  <tr
                    mat-header-row
                    *matHeaderRowDef="[
                      'serial',
                      'date',
                      'amount',
                      'method',
                      'ach'
                    ]"></tr>
                  <tr
                    mat-row
                    *matRowDef="
                      let row;
                      columns: ['serial', 'date', 'amount', 'method', 'ach']
                    "></tr>
                </table>

                <div
                  class="payments-total d-flex justify-content-end px-3 py-2">
                  <div class="text-muted me-3">Total</div>
                  <div class="fw-bold mono">
                    {{ getPaymentsTotal(pays) | currency }}
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #noPayments>
              <div class="d-flex align-items-center text-muted py-2">
                <mat-icon class="me-2">info</mat-icon>
                No payments recorded for this invoice.
              </div>
            </ng-template>
          </ng-container>

          <ng-template #paymentsState>
            <div class="d-flex align-items-center gap-2 py-1">
              <mat-progress-spinner
                *ngIf="
                  loadingRowId === element._id && !hasErrorForRow(element._id)
                "
                mode="indeterminate"
                diameter="20">
              </mat-progress-spinner>

              <button
                *ngIf="hasErrorForRow(element._id)"
                mat-stroked-button
                color="primary"
                (click)="retryLoad(element, $event)">
                Retry
              </button>
            </div>
          </ng-template>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="serial">
      <th mat-header-cell *matHeaderCellDef>Invoice Number</th>
      <td
        mat-cell
        *matCellDef="let element"
        class="light-blue-700"
        style="cursor: pointer">
        <span
          class="me-2"
          (click)="toggleRow(element); $event.stopPropagation()"
          style="user-select: none">
          {{ expanded === element ? '▾' : '▸' }}
        </span>

        <span (click)="_url.navigateTo(urlDetails || '', element.serial)">
          #{{ element.serial | notNull }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="policy_number">
      <th mat-header-cell *matHeaderCellDef>Policy Number</th>
      <td
        mat-cell
        *matCellDef="let element"
        class="light-blue-700"
        style="cursor: pointer"
        (click)="_url.navigateTo('portal/policies', element.policy.serial)">
        {{ element.policy?.policy_number | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="amount">
      <th mat-header-cell *matHeaderCellDef>Invoice Amount</th>
      <td mat-cell *matCellDef="let element">
        {{ element.amount_due | currency | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="balance">
      <th mat-header-cell *matHeaderCellDef>Invoice Balance</th>
      <td mat-cell *matCellDef="let element">
        {{ element.amount_due - element.amount_paid | currency | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="invoice_to">
      <th mat-header-cell *matHeaderCellDef>Invoice To</th>

      <td
        mat-cell
        *matCellDef="let element"
        class="light-blue-700"
        style="cursor: pointer"
        (click)="
          _url.navigateTo(
            element.serial.includes('INVI')
              ? 'portal/insurer'
              : 'portal/accounts',
            element.serial.includes('INVI')
              ? element.insurer.serial
              : element.client.serial
          )
        ">
        {{
          element.serial.includes('INVI')
            ? element.insurer?.name
            : element.client?.account_name
        }}
      </td>
    </ng-container>

    <ng-container matColumnDef="aging_days">
      <th mat-header-cell *matHeaderCellDef class="text-center">
        Aging (days)
      </th>
      <td mat-cell *matCellDef="let element" class="text-center">
        {{ getInvoiceAging(element) ?? '—' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="category">
      <th mat-header-cell *matHeaderCellDef>Policy Cycle</th>
      <td mat-cell *matCellDef="let element">
        {{ element.policy.category | enum | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let element">
        <span [ngClass]="getStatusClass(element.status)">
          {{ element.status | enum | notNull }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="invoice_date">
      <th mat-header-cell *matHeaderCellDef>Invoice Date</th>
      <td mat-cell *matCellDef="let element">
        {{ element.createdAt | date | notNull }}
      </td>
    </ng-container>

    <ng-container matColumnDef="actions" stickyEnd>
      <th mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let element">
        <div class="d-flex align-items-center">
          <span
            class="material-icons-outlined me-2"
            style="cursor: pointer"
            matTooltip="Download this invoice"
            (click)="openDownload(element.pdf); $event.stopPropagation()">
            download
          </span>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

    <tr
      mat-row
      *matRowDef="let row; columns: displayedColumns"
      class="mas-table-row"
      (click)="toggleRow(row)"
      style="cursor: pointer"></tr>

    <tr
      mat-row
      *matRowDef="let row; columns: ['detail']"
      [style.display]="expanded === row ? 'table-row' : 'none'"
      class="bg-light"></tr>

    <tr *matNoDataRow>
      <td colspan="11">
        <app-default-empty-state
          *ngIf="!filtersActive.length"></app-default-empty-state>
        <app-filter-empty-state
          *ngIf="filtersActive.length"></app-filter-empty-state>
      </td>
    </tr>
  </table>
</div>

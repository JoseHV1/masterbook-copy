<app-pages-layout>
  <ng-container content>
    <div class="d-flex align-items-center">
      <div class="px-2">
        <span
          class="material-icons-outlined me-2"
          style="cursor: pointer"
          matTooltip="Back to last page"
          (click)="goBack()">
          arrow_back
        </span>
      </div>
    </div>

    <div *ngIf="emailDetail">
      <div class="header">
        <h1>{{ emailDetail[0].subject }}</h1>
        <p class="text-sm text-gray-600">
          <strong>From:</strong> {{ emailDetail[0].from }}
          <span *ngIf="emailDetail[emailDetail.length - 1].cc">
            | <strong>CC:</strong>
            {{ emailDetail[emailDetail.length - 1].cc }}</span
          >
        </p>
        <p>
          <strong>Date:</strong> {{ emailDetail[0].date | date : 'medium' }}
        </p>
        <hr />
      </div>

      <ng-container *ngFor="let message of emailDetail">
        <div class="email-body">
          <p class="text-xs text-gray-500 mb-2">
            From: {{ message.from }} | To: {{ message.to }}
            <span *ngIf="message.cc">| CC: {{ message.cc }}</span>
            | {{ message.date | date : 'short' }}
          </p>
          <div [innerHTML]="message.safeHtmlBody"></div>
        </div>

        <hr />

        <h2>Attachment ({{ attachment.length }})</h2>

        <div
          class="attachments-row"
          *ngIf="attachment.length > 0"
          style="display: flex; gap: 12px; flex-wrap: wrap; margin: 8px 0">
          <div
            *ngFor="let file of attachment"
            class="attachment-card"
            style="
              display: flex;
              flex-direction: column;
              align-items: flex-start;
              width: 220px;
              padding: 10px;
              border: 1px solid #e6e6e6;
              border-radius: 8px;
              background: #fff;
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            "
            (click)="$event.stopPropagation()">
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                width: 100%;
              ">
              <ng-container *ngIf="file.contentType?.startsWith('image')">
                <img
                  [src]="file.thumbnailUrl || file.previewUrl || file.url"
                  alt="{{ file.filename }}"
                  style="
                    width: 48px;
                    height: 48px;
                    object-fit: cover;
                    border-radius: 4px;
                    border: 1px solid #ddd;
                  " />
              </ng-container>

              <ng-container *ngIf="!file.contentType?.startsWith('image')">
                <span
                  class="material-icons"
                  style="font-size: 36px; color: #616161"
                  >insert_drive_file</span
                >
              </ng-container>

              <div style="flex: 1; min-width: 0">
                <div
                  style="
                    font-weight: 600;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                  ">
                  {{ file.filename }}
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 4px">
                  {{
                    file.size
                      ? (file.size | number : '1.0-0') + ' bytes'
                      : file.contentType || ''
                  }}
                </div>
              </div>
            </div>

            <div
              style="
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                width: 100%;
                margin-top: 10px;
              ">
              <button
                type="button"
                class="icon-only"
                style="
                  background: #f3f4f6;
                  border: 1px solid #e5e7eb;
                  padding: 6px 8px;
                  border-radius: 6px;
                  font-size: 13px;
                  cursor: pointer;
                "
                (click)="
                  getDownloadUrl(message.id, file.attachmentId, file.filename);
                  $event.stopPropagation()
                ">
                <span
                  class="material-icons"
                  style="font-size: 16px; vertical-align: middle"
                  >download</span
                >
                <span style="margin-left: 6px">Download</span>
              </button>

              <a
                *ngIf="file.url"
                [href]="file.url"
                target="_blank"
                (click)="$event.stopPropagation()"
                class="icon-only"
                style="
                  display: inline-flex;
                  align-items: center;
                  padding: 6px 8px;
                  border-radius: 6px;
                  border: 1px solid #e5e7eb;
                  background: #fff;
                  text-decoration: none;
                  color: inherit;
                  font-size: 13px;
                ">
                <span
                  class="material-icons"
                  style="font-size: 16px; vertical-align: middle"
                  >preview</span
                >
                <span style="margin-left: 6px">Ver</span>
              </a>
            </div>
          </div>
        </div>

        <p *ngIf="attachment.length === 0">No hay archivos adjuntos.</p>
      </ng-container>

      <div>
        <div class="w-100 d-flex align-items-center flex-wrap" style="gap: 8px">
          <button
            (click)="toggleReplyForm('reply')"
            class="primary-button big-button back-light-blue-500 white flex-grow-1">
            Reply
          </button>

          <button
            (click)="toggleReplyForm('replyAll')"
            class="primary-button big-button back-light-blue-500 white flex-grow-1">
            Reply All
          </button>

          <button
            (click)="toggleForwardForm()"
            class="primary-button big-button back-light-blue-500 white flex-grow-1">
            Forward
          </button>

          <button
            type="button"
            (click)="viewAsPdf()"
            class="primary-button big-button back-light-blue-500 white flex-grow-1">
            <span
              class="material-icons"
              style="font-size: 18px; vertical-align: middle"
              >picture_as_pdf</span
            >
            <span>PDF</span>
          </button>
        </div>
      </div>

      <div
        *ngIf="isReplying"
        class="reply-form-container mt-4 p-3 border rounded">
        <h3>
          Replay {{ replyType === 'replyAll' ? 'all' : 'to:' }}
          <span *ngIf="replyType === 'reply'">{{
            _extractEmailAddress(emailDetail[emailDetail.length - 1].from)
          }}</span>
        </h3>

        <textarea
          [(ngModel)]="replyText"
          rows="5"
          class="form-control w-100 mb-2"
          placeholder="Write your answer here..."></textarea>

        <div class="d-flex justify-content-center gap-2">
          <button
            (click)="cancelReply()"
            class="primary-button big-button back-gray-400 white">
            Cancel
          </button>
          <button
            (click)="sendReply()"
            [disabled]="!replyText.trim()"
            class="primary-button big-button back-light-blue-500 white">
            Send
          </button>
        </div>
      </div>

      <div
        *ngIf="isForwarding"
        class="forward-form-container mt-4 p-4 border rounded-lg bg-white shadow-md">
        <h3 class="text-lg font-semibold mb-3">Forward email</h3>

        <label
          for="forwardTo"
          class="block text-sm font-medium text-gray-700 mb-1"
          >Receiver:</label
        >
        <input
          id="forwardTo"
          type="email"
          [(ngModel)]="forwardRecipient"
          class="form-control w-full p-2 border border-gray-300 rounded-md mb-3 focus:border-purple-500 focus:ring-purple-500"
          placeholder="example@domain.com" />

        <label
          for="forwardBody"
          class="block text-sm font-medium text-gray-700 mb-1"
          >Your message (optional):</label
        >
        <textarea
          id="forwardBody"
          [(ngModel)]="replyText"
          rows="5"
          class="form-control w-full p-2 border border-gray-300 rounded-md mb-3 focus:border-purple-500 focus:ring-purple-500"
          placeholder="Write an introductory message..."></textarea>

        <div class="d-flex justify-content-center gap-2">
          <button
            (click)="cancelForward()"
            class="primary-button big-button back-gray-400 white">
            Cancel
          </button>
          <button
            (click)="sendForward()"
            [disabled]="!forwardRecipient.trim()"
            class="primary-button big-button back-light-blue-500 white">
            Resend
          </button>
        </div>
      </div>
    </div>
  </ng-container>
</app-pages-layout>
